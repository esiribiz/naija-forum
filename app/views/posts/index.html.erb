<% 
  page_title = if @tag
    "Posts tagged with ##{@tag.name}"
  elsif @tag_category
    category_name = {
      'geographic' => 'Geographic Tags',
      'professional' => 'Professional Tags', 
      'country_region' => 'Diaspora Tags',
      'special_project' => 'Special Projects'
    }[@tag_category] || @tag_category.humanize
    "Posts in #{category_name}"
  elsif @category
    "Posts in #{@category.name}"
  else
    "All Posts"
  end
%>
<% content_for :title, page_title %>
<div class="flex">
  <!-- Main Content -->
  <main class="flex-1 p-6 bg-gray-50">
    <%= render 'shared/navigation_menu' %>
    <!-- Header with Nigerian color theme -->
    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white py-4 px-6 rounded-lg mb-6 shadow-md relative overflow-hidden">
      <div class="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -mr-6 -mt-6"></div>
      <div class="absolute bottom-0 left-0 w-16 h-16 bg-white opacity-10 rounded-full -ml-4 -mb-4"></div>
      
      <div class="flex justify-between items-center relative z-10">
        <div>
          <h1 class="text-2xl font-bold"><%= page_title %></h1>
          <% if @tag %>
            <p class="text-green-100 text-sm mt-1">
              <% case @tag.category %>
              <% when 'geographic' %>
                üìç Geographic tag
              <% when 'professional' %>
                üíº Professional tag
              <% when 'country_region' %>
                üåç Diaspora tag
              <% when 'special_project' %>
                ‚≠ê Special project tag
              <% else %>
                üè∑Ô∏è General tag
              <% end %>
              ‚Ä¢ <%= pluralize(@posts.count, 'post') %>
            </p>
          <% elsif @tag_category %>
            <p class="text-green-100 text-sm mt-1">
              <%= pluralize(@posts.count, 'post') %> found
            </p>
          <% end %>
        </div>
        <div class="flex items-center">
          <%= link_to new_post_path, class: "inline-flex items-center px-4 py-2 bg-green-500 text-white text-sm font-medium rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-sm hover:shadow-md" do %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-2">
              <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
            </svg>
            New Post
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Breadcrumb Navigation for Tag Filtering -->
    <% if @tag || @tag_category %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <nav class="flex items-center space-x-2 text-sm text-gray-600">
          <%= link_to posts_path, class: "text-green-600 hover:text-green-800 font-medium" do %>
            All Posts
          <% end %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          <%= link_to tags_path, class: "text-green-600 hover:text-green-800 font-medium" do %>
            Tags
          <% end %>
          <% if @tag %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
            <span class="font-medium text-gray-900">#<%= @tag.name %></span>
          <% elsif @tag_category %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
            <span class="font-medium text-gray-900">
              <%= {
                'geographic' => 'Geographic Tags',
                'professional' => 'Professional Tags', 
                'country_region' => 'Diaspora Tags',
                'special_project' => 'Special Projects'
              }[@tag_category] || @tag_category.humanize %>
            </span>
          <% end %>
        </nav>
      </div>
    <% end %>
    
    <!-- Posts Grid -->
    <div class="grid gap-6 md:grid-cols-1 lg:grid-cols-2">
      <% if @posts.present? %>
        <% @posts.each do |post| %>
          <!-- Post Card -->
          <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 border-green-500 relative group">
            
            <!-- Clickable Link Overlay -->
            <% if user_signed_in? %>
              <%= link_to post_path(post), class: "absolute inset-0 z-10 rounded-xl" do %>
                <span class="sr-only">View <%= post.title %></span>
              <% end %>
            <% else %>
              <%= link_to new_user_session_path, class: "absolute inset-0 z-10 rounded-xl" do %>
                <span class="sr-only">Sign in to view <%= post.title %></span>
              <% end %>
            <% end %>
            
            <!-- User Avatar Section -->
            <div class="p-5 border-b border-gray-100">
                <div class="flex items-center space-x-4">
                  <% if post.user&.avatar&.attached? %>
                    <%= image_tag post.user.avatar, class: "w-12 h-12 rounded-full ring-2 ring-green-100" %>
                  <% else %>
                    <div class="w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                      <%= post.user&.username&.first(2)&.upcase || "UN" %>
                    </div>
                  <% end %>
                  <div class="flex-1">
                    <p class="text-sm text-gray-500">
                      <%= time_ago_in_words(post.created_at) %> ago by 
                      <span class="font-medium"><%= post.user&.username || 'Anonymous' %></span>
                    </p>
                  </div>
                  <%= online_dot(post.user, class: 'ml-2') if defined?(online_dot) %>
                </div>
              </div>
              
              <!-- Post Image -->
              <% if post.images.attached? %>
                <div>
                  <%= image_tag post.images.first, class: "w-full h-48 object-cover" if post.images.first %>
                </div>
              <% end %>
              
              <!-- Post Title & Content -->
              <div class="p-5">
                <h2 class="text-xl font-bold text-gray-800 group-hover:text-green-600 transition-colors duration-200 mb-3">
                  <%= post.title %>
                  <% unless user_signed_in? %>
                    <span class="block text-xs text-green-600 font-normal mt-1">üîí Sign in to read this post</span>
                  <% end %>
                </h2>
                <p class="text-gray-700 leading-relaxed mb-3"><%= truncate(post.body, length: 180) %></p>
                
                <!-- Tags -->
                <% if post.tags.any? %>
                  <div class="flex flex-wrap gap-2 mb-3">
                    <% post.tags.limit(5).each do |tag| %>
                      <% 
                        tag_color = case tag.category
                                   when 'geographic' then 'bg-blue-100 text-blue-800'
                                   when 'professional' then 'bg-green-100 text-green-800'
                                   when 'country_region' then 'bg-purple-100 text-purple-800'
                                   when 'special_project' then 'bg-yellow-100 text-yellow-800'
                                   else 'bg-gray-100 text-gray-800'
                                   end
                      %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium <%= tag_color %> relative z-30">
                        #<%= tag.name %>
                      </span>
                    <% end %>
                    <% if post.tags.count > 5 %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        +<%= post.tags.count - 5 %> more
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              
              <!-- Post Footer -->
              <div class="px-5 pb-5">
                <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
                  <div class="flex items-center text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-green-500">
                      <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 006 21.75a6.721 6.721 0 003.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 01-.814 1.686.75.75 0 00.44 1.223zM8.25 10.875a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM10.875 12a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0zm4.875-1.125a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25z" clip-rule="evenodd" />
                    </svg>
                    <%= pluralize(post.comments.count, "comment") %>
                  </div>
                  
                  <!-- Post Actions -->
                  <div class="flex space-x-3 relative z-20">
                    <% if user_signed_in? && current_user == post.user %>
                      <%= link_to edit_post_path(post), class: "text-amber-500 hover:text-amber-600 transition-colors flex items-center text-sm" do %>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                          <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" />
                        </svg>
                        Edit
                      <% end %>
                      <%= button_to post, method: :delete, data: { turbo_confirm: "Are you sure you want to delete this post?" }, class: "text-red-500 hover:text-red-600 transition-colors flex items-center text-sm" do %>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                          <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 001.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" />
                        </svg>
                        Delete
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
          </div>
        <% end %>
      <% else %>
        <div class="col-span-full bg-white p-8 rounded-xl shadow text-center">
          <p class="text-gray-500 text-lg">No posts available yet. Be the first to create a post!</p>
        </div>
      <% end %>
    </div>
    
    <!-- Pagination -->
    <div class="mt-8 flex justify-center">
      <%= paginate @posts, class: "inline-flex shadow-sm rounded-md overflow-hidden" %>
    </div>
  </main>
</div>
