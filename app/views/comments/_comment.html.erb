<div id="comment_<%= comment.id %>" 
     class="ml-<%= comment.parent_id.present? ? 8 : 0 %> mb-5">
  <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
    <div class="flex items-start space-x-3">
      <div>
        <% if comment.user.avatar.attached? %>
          <%= image_tag comment.user.avatar, class: "w-10 h-10 rounded-full" %>
        <% else %>
          <div class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold">
            <%= comment.user.username.first(1).upcase %>
          </div>
        <% end %>
      </div>

      <div class="flex-1">
        <div class="flex items-center space-x-2 mb-1">
          <span class="font-semibold"><%= comment.user.username %></span>
          <span class="text-xs text-gray-400"><%= time_ago_in_words(comment.created_at) %> ago</span>
        </div>
        <p class="text-gray-700"><%= linkify_content(comment.content) %></p>

        <div class="flex space-x-3 mt-2 text-sm">
          <%= link_to "Reply", new_post_comment_path(comment.post, parent_id: comment.id),
              data: { turbo_stream: true },
              class: "text-green-600 hover:underline" %>

          <% if comment.can_be_edited_by?(current_user) %>
            <%= link_to "Edit", edit_post_comment_path(comment.post, comment), data: { turbo_stream: true }, class: "text-gray-500 hover:text-gray-700" %>
          <% end %>

          <% if comment.can_be_deleted_by?(current_user) %>
            <%= button_to "Delete", post_comment_path(comment.post, comment),
                method: :delete,
                form: { data: { turbo_stream: true, turbo_confirm: "Are you sure?" } },
                class: "text-red-600 hover:underline" %>
          <% end %>
        </div>

        <div id="reply-form-<%= comment.id %>" class="mt-2"></div>

        <!-- Collapsible replies section -->
        <% if comment.replies.any? %>
          <div data-controller="collapsible-replies" class="mt-4">
            <div data-collapsible-replies-target="toggleButton"
                 data-action="click->collapsible-replies#toggle"
                 class="cursor-pointer text-sm text-blue-600 hover:underline mb-2 flex items-center">
              <span class="text-sm mr-1">âˆ’</span>
              <span data-collapsible-replies-target="replyCount"><%= comment.replies.count %></span>
              <span class="ml-1"><%= comment.replies.count == 1 ? 'reply' : 'replies' %></span>
            </div>

            <div data-collapsible-replies-target="repliesContainer" 
                 class="transition-all duration-300 ease-in-out border-l border-gray-200 pl-4 space-y-3">
              <%= render partial: "comments/comment", collection: comment.replies.order(created_at: :asc), as: :comment, locals: { post: post } %>
            </div>
          </div>
        <% else %>
          <!-- Empty replies container for turbo stream updates -->
          <div id="comment_<%= comment.id %>_replies" class="mt-4"></div>
        <% end %>
      </div>
    </div>
  </div>
</div>
